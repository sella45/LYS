package com.korit.crud.repository.implement;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import com.korit.crud.entity.BoardEntity;
import com.korit.crud.repository.BoardRepository;
import com.korit.crud.vo.BoardListVO;
import com.korit.crud.vo.BoardViewVO;

public class BoardRepositoryImplement implements BoardRepository {

	private final Connection connection;
	
	public BoardRepositoryImplement(Connection connection) {
		this.connection = connection;
	}

	@Override
	public void save(BoardEntity boardEntity) {
		final String SQL = "INSERT INTO board (title, contents, write_date, writer_id) VALUES (?, ?, CURDATE(), ?)";
		
		try (PreparedStatement preparedStatement = connection.prepareStatement(SQL)) {
			preparedStatement.setString(1, boardEntity.getTitle());
			preparedStatement.setString(2, boardEntity.getContents());
			preparedStatement.setString(3, boardEntity.getWriterId());
			preparedStatement.executeUpdate();
		} catch (Exception exception) {
			exception.printStackTrace();
		}
	}

	@Override
	public List<BoardListVO> findAll() {
	    Set<BoardListVO> boardSet = new HashSet<>();  // ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ Set ì‚¬ìš©
	    
	    final String SQL = "SELECT B.board_number, B.title, COALESCE(U.nickname, 'ì•Œ ìˆ˜ ì—†ìŒ') AS nickname, B.write_date " +
	                       "FROM board B LEFT JOIN user U ON B.writer_id = U.id " +
	                       "ORDER BY B.board_number DESC";
	    
	    

	    try (PreparedStatement preparedStatement = connection.prepareStatement(SQL);
	         ResultSet resultSet = preparedStatement.executeQuery()) {

	        boolean hasResults = false;  // ê²°ê³¼ ì—¬ë¶€ í™•ì¸ìš© ë³€ìˆ˜

	        while (resultSet.next()) {
	            hasResults = true;  // ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš° trueë¡œ ë³€ê²½

	            Integer boardNumber = resultSet.getInt("board_number");
	            String title = resultSet.getString("title");
	            
	            ResultSetMetaData metaData = resultSet.getMetaData();
	            int columnCount = metaData.getColumnCount();
	            System.out.println("ğŸ“Œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë°˜í™˜ëœ ì»¬ëŸ¼ ëª©ë¡:");

	            for (int i = 1; i <= columnCount; i++) {
	                System.out.println(metaData.getColumnName(i));  // í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¨ ì»¬ëŸ¼ëª… ì¶œë ¥
	            }

	            // ì´ì œ contents ê°€ì ¸ì˜¤ê¸°
	            String contents = resultSet.getString("contents");
	            String writerNickname = resultSet.getString("nickname");
	            String writeDate = resultSet.getString("write_date");

	            System.out.println("-----------------------------------------");
	            System.out.println("ê²Œì‹œê¸€ ë²ˆí˜¸: " + boardNumber);
	            System.out.println("ì œëª©: " + title);
	            System.out.println("ë‚´ìš©: " + contents); 
	            System.out.println("ì‘ì„±ì ë‹‰ë„¤ì„: " + writerNickname);
	            System.out.println("ì‘ì„±ì¼: " + writeDate);

	            BoardListVO vo = new BoardListVO(boardNumber, title, contents, writerNickname, writeDate);
	            boardSet.add(vo);
	        }

	        if (!hasResults) {
	            System.out.println("âš ï¸ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
	        } else {
	            System.out.println("âœ… ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì´ ê°œìˆ˜: " + boardSet.size());
	        }

	    } catch(Exception exception) {
	        exception.printStackTrace();
	    }

	    return new ArrayList<>(boardSet);
	}

	@Override
	public BoardViewVO findById(Integer boardNumber) {
		BoardViewVO board = null;
		
		final String SQL = "SELECT B.title, B.contents, B.writer_id, U.nickname, B.write_date " +
						   "FROM board B INNER JOIN user U ON B.writer_id = U.id " +
						   "WHERE B.board_number = ?";
		
		try (PreparedStatement preparedStatement = connection.prepareStatement(SQL)) {
			preparedStatement.setInt(1, boardNumber);
			ResultSet resultSet = preparedStatement.executeQuery();
			
			if (resultSet.next()) {
				String title = resultSet.getString("title");
				String contents = resultSet.getString("contents");
				String writerId = resultSet.getString("writer_id");
				String writerNickname = resultSet.getString("nickname");
				String writeDate = resultSet.getString("write_date");
				
				board = new BoardViewVO(title, contents, writerId, writerNickname, writeDate);
			}
		} catch (Exception exception) {
			exception.printStackTrace();
		}
		
		return board;
	}
	
	@Override
	public boolean existsById(Integer boardNumber) {
		boolean exist = false;
		
		final String SQL = "SELECT COUNT(*) FROM board WHERE board_number = ?";
		
		try (PreparedStatement preparedStatement = connection.prepareStatement(SQL)) {
			preparedStatement.setInt(1, boardNumber);
			ResultSet resultSet = preparedStatement.executeQuery();
			
			if (resultSet.next()) {
				exist = resultSet.getInt(1) > 0;
			}
		} catch (Exception exception) {
			exception.printStackTrace();
		}
		
		return exist;
	}

	@Override
	public boolean updateByTitleAndContents(Integer boardNumber, String title, String contents) {
		boolean result = false;
		
		final String SQL = "UPDATE board SET title = ?, contents = ? WHERE board_number = ?";
		
		try (PreparedStatement preparedStatement = connection.prepareStatement(SQL)) {
			preparedStatement.setString(1, title);
			preparedStatement.setString(2, contents);
			preparedStatement.setInt(3, boardNumber);
			preparedStatement.executeUpdate();		
			
			result = true;
		} catch (Exception exception) {
			exception.printStackTrace();
		}
		
		return result;
	}

	@Override
	public boolean deleteByBoardNumber(Integer boardNumber) {
		boolean result = false;
		
		final String SQL = "DELETE FROM board WHERE board_number = ?";
		
		try (PreparedStatement preparedStatement = connection.prepareStatement(SQL)) {
			preparedStatement.setInt(1, boardNumber);
			preparedStatement.executeUpdate();			
			
			result = true;	
		} catch (Exception exception) {
			exception.printStackTrace();
		}
		
		return result;
	}

}